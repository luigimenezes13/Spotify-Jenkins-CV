pipeline {
    agent any
    
    triggers {
        pollSCM('H/5 * * * *')
    }
    
    environment {
        NODE_VERSION = '20'
        WORKSPACE_DIR = 'server'
    }
    
    stages {
        stage('Checkout') {
            steps {
                echo 'Fazendo checkout do c√≥digo...'
                checkout scm
            }
        }
        
        stage('Setup Environment') {
            steps {
                echo 'Configurando ambiente Node.js...'
                dir("${WORKSPACE_DIR}") {
                    sh '''
                        # Instalar Node.js via nvm
                        curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
                        export NVM_DIR="$HOME/.nvm"
                        [ -s "$NVM_DIR/nvm.sh" ] && source "$NVM_DIR/nvm.sh"
                        nvm install ${NODE_VERSION}
                        nvm use ${NODE_VERSION}
                        
                        # Instalar pnpm
                        npm install -g pnpm@latest
                        
                        # Verificar vers√µes
                        node --version
                        npm --version
                        pnpm --version
                    '''
                }
            }
        }
        
        stage('Install Dependencies') {
            steps {
                echo 'Instalando depend√™ncias do projeto NestJS...'
                dir("${WORKSPACE_DIR}") {
                    sh '''
                        export NVM_DIR="$HOME/.nvm"
                        [ -s "$NVM_DIR/nvm.sh" ] && source "$NVM_DIR/nvm.sh"
                        nvm use ${NODE_VERSION}
                        
                        # Instalar depend√™ncias
                        pnpm install --frozen-lockfile
                    '''
                }
            }
        }
        
        stage('Lint') {
            steps {
                echo 'Executando linting...'
                dir("${WORKSPACE_DIR}") {
                    sh '''
                        export NVM_DIR="$HOME/.nvm"
                        [ -s "$NVM_DIR/nvm.sh" ] && source "$NVM_DIR/nvm.sh"
                        nvm use ${NODE_VERSION}
                        pnpm run lint:check
                    '''
                }
            }
        }
        
        stage('Format Check') {
            steps {
                echo 'Verificando formata√ß√£o do c√≥digo...'
                dir("${WORKSPACE_DIR}") {
                    sh '''
                        export NVM_DIR="$HOME/.nvm"
                        [ -s "$NVM_DIR/nvm.sh" ] && source "$NVM_DIR/nvm.sh"
                        nvm use ${NODE_VERSION}
                        pnpm run format:check
                    '''
                }
            }
        }
        
        stage('Type Check') {
            steps {
                echo 'Verificando tipos TypeScript...'
                dir("${WORKSPACE_DIR}") {
                    sh '''
                        export NVM_DIR="$HOME/.nvm"
                        [ -s "$NVM_DIR/nvm.sh" ] && source "$NVM_DIR/nvm.sh"
                        nvm use ${NODE_VERSION}
                        pnpm run typecheck
                    '''
                }
            }
        }
        
        stage('Test') {
            steps {
                echo 'Executando testes com cobertura...'
                dir("${WORKSPACE_DIR}") {
                    sh '''
                        export NVM_DIR="$HOME/.nvm"
                        [ -s "$NVM_DIR/nvm.sh" ] && source "$NVM_DIR/nvm.sh"
                        nvm use ${NODE_VERSION}
                        pnpm run test:cov
                    '''
                }
            }
            post {
                always {
                    echo 'Publicando relat√≥rio de cobertura...'
                    dir("${WORKSPACE_DIR}") {
                        script {
                            // Vitest gera cobertura em coverage/index.html
                            // Verificar se existe e publicar
                            def coverageExists = sh(
                                script: 'test -f coverage/index.html || test -f coverage/lcov-report/index.html',
                                returnStatus: true
                            ) == 0
                            
                            if (coverageExists) {
                                publishHTML([
                                    allowMissing: true,
                                    alwaysLinkToLastBuild: true,
                                    keepAll: true,
                                    reportDir: 'coverage',
                                    reportFiles: 'index.html',
                                    reportName: 'Coverage Report'
                                ])
                            } else {
                                echo '‚ö†Ô∏è Relat√≥rio de cobertura n√£o encontrado, pulando publica√ß√£o'
                            }
                        }
                    }
                }
            }
        }
        
        stage('Build NestJS') {
            steps {
                echo 'Compilando aplica√ß√£o NestJS...'
                dir("${WORKSPACE_DIR}") {
                    sh '''
                        export NVM_DIR="$HOME/.nvm"
                        [ -s "$NVM_DIR/nvm.sh" ] && source "$NVM_DIR/nvm.sh"
                        nvm use ${NODE_VERSION}
                        pnpm run build
                        
                        # Verificar se o build foi criado
                        if [ -d "dist" ]; then
                            echo "‚úÖ Build criado com sucesso!"
                            ls -la dist/
                        else
                            echo "‚ùå Erro: Diret√≥rio dist/ n√£o encontrado"
                            exit 1
                        fi
                    '''
                }
            }
        }
        
        stage('Build Docker Image') {
            steps {
                echo 'Construindo imagem Docker...'
                dir("${WORKSPACE_DIR}") {
                    script {
                        try {
                            def image = docker.build("spotify-jenkins-cv:${env.BUILD_NUMBER}")
                            echo "‚úÖ Imagem Docker constru√≠da: spotify-jenkins-cv:${env.BUILD_NUMBER}"
                            
                            // Apenas fazer push se credenciais estiverem configuradas
                            // Comentado para n√£o falhar se n√£o houver registry configurado
                            // docker.withRegistry('', 'docker-registry-credentials') {
                            //     image.push("latest")
                            //     image.push("${env.BUILD_NUMBER}")
                            // }
                        } catch (Exception e) {
                            echo "‚ö†Ô∏è Aviso: Erro ao construir imagem Docker: ${e.message}"
                            echo "O build continuar√° mesmo sem a imagem Docker"
                            // N√£o falha o pipeline se Docker n√£o estiver dispon√≠vel
                        }
                    }
                }
            }
        }
        
        stage('Deploy to Staging') {
            when {
                branch 'develop'
            }
            steps {
                echo 'Fazendo deploy para staging...'
                // Adicionar comandos de deploy para staging aqui
            }
        }
        
        stage('Deploy to Production') {
            when {
                branch 'main'
            }
            steps {
                echo 'Fazendo deploy para produ√ß√£o...'
                // Adicionar comandos de deploy para produ√ß√£o aqui
            }
        }
    }
    
    post {
        always {
            echo 'Pipeline finalizado'
            // N√£o limpar workspace automaticamente para preservar artefatos
            // cleanWs() // Comentado para preservar artefatos de build
        }
        success {
            echo '‚úÖ Pipeline executado com sucesso!'
            echo 'üì¶ Build NestJS dispon√≠vel em: server/dist/'
            echo 'üê≥ Imagem Docker: spotify-jenkins-cv:${env.BUILD_NUMBER}'
        }
        failure {
            echo '‚ùå Pipeline falhou!'
            echo 'üìã Verifique os logs acima para mais detalhes'
            // Adicionar notifica√ß√µes de falha aqui (email, Slack, etc.)
        }
        unstable {
            echo '‚ö†Ô∏è Pipeline inst√°vel!'
            echo 'Alguns testes ou verifica√ß√µes falharam, mas o build pode ter sido criado'
        }
    }
}
